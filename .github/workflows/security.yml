name: Security Scanning

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  schedule:
    - cron: '0 6 * * 1'  # Weekly scan every Monday at 6 AM UTC
  workflow_dispatch:

concurrency:
  group: security-${{ github.head_ref || github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  security-events: write

env:
  TRIVY_CACHE_DIR: .cache/trivy

jobs:
  trivy:
    name: Trivy Vulnerability Scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Cache Trivy DB
        uses: actions/cache@v5
        with:
          path: ${{ env.TRIVY_CACHE_DIR }}
          key: trivy-db-${{ runner.os }}-${{ github.run_id }}
          restore-keys: trivy-db-${{ runner.os }}-

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install dependencies
        run: |
          if [ "${{ github.actor }}" = "dependabot[bot]" ]; then
            npm install --package-lock-only --ignore-scripts
            npm ci
          else
            npm ci
          fi

      - name: Generate npm SBOM
        run: npx @cyclonedx/cyclonedx-npm --spec-version 1.5 --omit dev --output-format JSON --output-file sbom-npm.json

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install cargo-cyclonedx
        uses: taiki-e/install-action@v2
        with:
          tool: cargo-cyclonedx@0.5.7

      - name: Generate Rust SBOM
        run: |
          cd src-tauri
          cargo cyclonedx --format json --spec-version 1.5 --no-build-deps --override-filename sbom-rust
          mv sbom-rust.json ../sbom-rust.json

      - name: Scan npm SBOM with Trivy
        uses: aquasecurity/trivy-action@0.34.1
        with:
          scan-type: 'sbom'
          scan-ref: 'sbom-npm.json'
          trivy-config: trivy.yaml
          format: 'sarif'
          output: 'trivy-npm.sarif'
          severity: 'HIGH,CRITICAL'
          exit-code: '0'
          cache-dir: ${{ env.TRIVY_CACHE_DIR }}

      - name: Scan Rust SBOM with Trivy
        uses: aquasecurity/trivy-action@0.34.1
        with:
          scan-type: 'sbom'
          scan-ref: 'sbom-rust.json'
          trivy-config: trivy.yaml
          format: 'sarif'
          output: 'trivy-rust.sarif'
          severity: 'HIGH,CRITICAL'
          exit-code: '0'
          cache-dir: ${{ env.TRIVY_CACHE_DIR }}

      - name: Scan filesystem for secrets and misconfigs
        uses: aquasecurity/trivy-action@0.34.1
        with:
          scan-type: 'fs'
          scan-ref: '.'
          trivy-config: trivy.yaml
          format: 'sarif'
          output: 'trivy-fs.sarif'
          severity: 'HIGH,CRITICAL'
          scanners: 'secret,misconfig'
          exit-code: '0'
          cache-dir: ${{ env.TRIVY_CACHE_DIR }}
          skip-dirs: '.dev,node_modules,target'

      - name: Upload Trivy npm results to Security tab
        uses: github/codeql-action/upload-sarif@v4
        if: always() && hashFiles('trivy-npm.sarif') != ''
        with:
          sarif_file: 'trivy-npm.sarif'
          category: 'trivy-npm'

      - name: Upload Trivy Rust results to Security tab
        uses: github/codeql-action/upload-sarif@v4
        if: always() && hashFiles('trivy-rust.sarif') != ''
        with:
          sarif_file: 'trivy-rust.sarif'
          category: 'trivy-rust'

      - name: Upload Trivy fs results to Security tab
        uses: github/codeql-action/upload-sarif@v4
        if: always() && hashFiles('trivy-fs.sarif') != ''
        with:
          sarif_file: 'trivy-fs.sarif'
          category: 'trivy-fs'

      - name: Upload Trivy artifacts
        uses: actions/upload-artifact@v6
        if: always() && (hashFiles('trivy-npm.sarif') != '' || hashFiles('trivy-rust.sarif') != '' || hashFiles('trivy-fs.sarif') != '')
        with:
          name: trivy-results
          path: |
            trivy-npm.sarif
            trivy-rust.sarif
            trivy-fs.sarif
          if-no-files-found: ignore
          retention-days: 30

  cargo-deny:
    name: Cargo Deny (Licenses, Bans, Sources)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Cargo
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: src-tauri
          shared-key: ubuntu-rust-deny

      - name: Install cargo-deny
        uses: taiki-e/install-action@v2
        with:
          tool: cargo-deny

      - name: Run cargo-deny
        working-directory: src-tauri
        run: cargo deny check

  cargo-audit:
    name: Cargo Audit (RustSec)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install cargo-audit
        uses: taiki-e/install-action@v2
        with:
          tool: cargo-audit

      - name: Run cargo-audit
        working-directory: src-tauri
        run: cargo audit

  lockfile-lint:
    name: Lockfile Integrity Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Lint lockfile registry sources
        run: npx lockfile-lint --type npm --path package-lock.json --validate-https --allowed-hosts npm

  semgrep:
    name: Semgrep SAST Scan
    runs-on: ubuntu-latest
    container:
      image: semgrep/semgrep
    if: github.actor != 'dependabot[bot]'
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Run Semgrep scan
        run: |
          semgrep scan \
            --config p/default \
            --config p/secrets \
            --config p/typescript \
            --config p/react \
            --config p/rust \
            --config .semgrep.yaml \
            --exclude-rule javascript.lang.security.audit.unsafe-formatstring.unsafe-formatstring \
            --exclude-rule rust.lang.security.current-exe.current-exe \
            --sarif \
            --output semgrep.sarif \
            --metrics off
        continue-on-error: true

      - name: Upload Semgrep results to Security tab
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        with:
          sarif_file: 'semgrep.sarif'
          category: 'semgrep'

      - name: Upload Semgrep artifacts
        uses: actions/upload-artifact@v6
        if: always()
        with:
          name: semgrep-results
          path: semgrep.sarif
          retention-days: 30
